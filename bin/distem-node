#!/usr/bin/ruby -w
$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')
# hack to allow running this script without installing the debian package
$:.unshift File.join(File.dirname(__FILE__), '..', 'debian/distem/usr/lib/ruby/vendor_ruby/1.8/x86_64-linux')

require 'distem'
require 'optparse'
require 'pathname'
require 'pp'

USAGE="Usage: #{$0} <vnode_name> [options]"

DEFAULT_COPY_PATH="/tmp"
ERR_VNONE=0
ERR_DAEMON=1

def errorcheck(errid,optvar,msg="")
  unless optvar
    case errid
      when ERR_DAEMON
	errmsg="You have to specify the daemon (option --daemon)"
      else
	errmsg = msg
    end
    pp errmsg
    exit
  end
end

options = {}

options['f_exec'] = false
options['f_shell'] = false
options['f_file_send'] = false
options['f_file_get'] = false
options['f_vnode_start'] = false
options['f_vnode_stop'] = false
options['f_image_get'] = false

options['ssh_user'] = 'root'
options['file_src'] = false
options['file_dest'] = false
options['exec_cmd'] = false
options['image_path'] = false
options['daemon_addr'] = 'localhost'
options['daemon_port'] = 4567

optparse = OptionParser.new(USAGE) do |opts|
  opts.on( '-h', '--help', 'Display this screen' ) do
    pp opts
    exit
  end
  opts.on( '-p', '--port NUMBER', \
    'The port that the daemon is listening on [default: 4567]' ) do |p|
    options['daemon_port'] = p
  end
  opts.on( '-u', '--ssh-user USERNAME', \
    'The username used to connect to a physical node through SSH [default: root]' ) do |u|
    options['ssh_user'] = u
  end
  opts.on( '-d', '--daemon ADDRESS', \
    'The address of the daemon [default: localhost]' ) do |h|
    options['daemon_addr'] = h
  end
  opts.on( '-s', '--start-vnode',\
    'Start the virtual node' ) \
    do 
    options['f_vnode_start'] = true
  end
  opts.on( '-t', '--stop-vnode',\
    'Stop the virtual node' ) \
    do |array|
    options['f_vnode_stop'] = true
  end
  opts.on( '-S', '--shell', \
    'Open a terminal on a Virtual Node (close it with <C-a q>)' ) do 
    options['f_shell'] = true
  end
  opts.on( '-e', '--execute COMMAND', \
    'Run a command on the Virtual Node' ) do |c|
    options['f_exec'] = true
    options['exec_cmd'] = c
  end
  opts.on( '-c', '--copy-to SOURCE,DEST', Array, \
    'Copy the SOURCE file into DEST on the Virtual Node (copy it into /tmp/ if the path is not absolute)' ) do |array|
    options['f_file_send'] = true
    options['file_src'] = array[0]
    options['file_dest'] = array[1]
  end
  opts.on( '-C', '--copy-from SOURCE,DEST', Array, \
    'Copy the SOURCE file from the Virtual node into DEST (copy it from /tmp/ if the path is not absolute)' ) do |array|
    options['f_file_get'] = true
    options['file_src'] = array[0]
    options['file_dest'] = array[1]
  end
  opts.on( '-I', '--get-image [DEST_PATH]', \
    'Get a compressed image file of the filesystem of the vnode' ) do |i| \
    options['f_image_get'] = true
    options['image_path'] = i || '.'
  end
end

optparse.parse!

unless ARGV.length == 1
  pp USAGE
  exit
end

cl=false

if (options['f_shell'])
  errorcheck(ERR_DAEMON,options['daemon_addr'])

  cl = Distem::NetAPI::Client.new(options['daemon_addr'],options['daemon_port']) unless cl
  vnode = cl.vnode_info(ARGV[0])
  system("ssh -t #{options['ssh_user']}@#{vnode['host']} 'lxc-console -n #{ARGV[0]}'")
end

if (options['f_exec'])
  errorcheck(ERR_DAEMON,options['daemon_addr'])

  cl = Distem::NetAPI::Client.new(options['daemon_addr'],options['daemon_port']) unless cl
  puts cl.vnode_execute(ARGV[0],options['exec_cmd']).join("\n")
end

if options['f_file_send'] or options['f_file_get']
  errorcheck(ERR_DAEMON,options['daemon_addr'])

  cl = Distem::NetAPI::Client.new(options['daemon_addr'],options['daemon_port']) unless cl
  vnode = cl.vnode_info(ARGV[0])
  pnode = vnode['host']
  if vnode['filesystem']['shared']
    rootfs = vnode['filesystem']['sharedpath']
  else
    rootfs = vnode['filesystem']['path']
  end
  if (options['f_file_send'])
    vfile = options['file_dest']
  else
    vfile = options['file_src']
  end

  path = Pathname.new(vfile)
  path = File.join(rootfs,(path.absolute? ? "" : DEFAULT_COPY_PATH),path.to_s)

  if (options['f_file_send'])
    system("scp -r #{options['file_src']} #{options['ssh_user']}@#{pnode}:#{path}")
  else
    system("scp -r #{options['ssh_user']}@#{pnode}:#{path} #{options['file_dest']}")
  end
end

if (options['f_vnode_start'])
  errorcheck(ERR_DAEMON,options['daemon_addr'])

  cl = Distem::NetAPI::Client.new(options['daemon_addr'],options['daemon_port']) unless cl
  pp cl.vnode_start(ARGV[0])
end

if (options['f_vnode_stop'])
  errorcheck(ERR_DAEMON,options['daemon_addr'])

  cl = Distem::NetAPI::Client.new(options['daemon_addr'],options['daemon_port']) unless cl
  pp cl.vnode_stop(ARGV[0])
end

if options['f_image_get']
  errorcheck(ERR_DAEMON,options['daemon_addr'])

  cl = Distem::NetAPI::Client.new(options['daemon_addr'],options['daemon_port']) unless cl
  vnode = cl.vnode_info(ARGV[0])
  cl2 = Distem::NetAPI::Client.new(vnode['host'])
  cl2.vnode_filesystem_get(vnode['name'],options['image_path'])
end
